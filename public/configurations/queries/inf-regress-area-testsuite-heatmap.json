{
    "id": "inf-regress-area-testsuite-heatmap",
    "service": "elasticsearch",
    "tabify":"areaHeatmap",
    "query": {
        "index": "nuage_regress",
        "type": "{{type:nuage_doc_type}}",
        "body": {
            "size": 0,
            "sort": [
                {
                    "time_ran_at": {
                        "order": "desc"
                    }
                }
            ],
            "query": {
                "bool": {
                    "must": [
                        {
                            "range": {
                                "time_ran_at": {
                                    "gte": "now-15d/d",
                                    "lte": "now/d",
                                    "format":"epoch_millis"
                                }
                            }
                        }
                    ],
                    "filter": {
                        "bool": {
                            "must": [
                                {
                                    "term": {
                                        "aql_area": "{{testsuiteArea}}"
                                    }
                                },
                                {
                                    "regexp":{
                                        "version.vrs":"[0-9].[0-9]/[0-9.]+"
                                    }
                                },
                                {
                                    "regexp":{
                                        "version.vsd":"[0-9].[0-9]/[0-9.]+"
                                    }
                                },
                                {
                                    "regexp":{
                                        "version.vsc":"[0-9].[0-9]/[0-9ISBN.]+"
                                    }
                                },
                                {
                                    "term": {
                                        "project": "{{branch}}"
                                    }
                                },
                                {"term":{"testcase":""}}
                            ]
                        }
                    }
                }
            },
            "aggs": {
                "date_histo": {
                    "date_histogram": {
                        "field": "time_ran_at",
                        "interval": "1d",
                        "format": "epoch_millis",
                        "time_zone": "America/Los_Angeles",
                        "extended_bounds":{
                            "min":"now-15d/d",
                            "max":"now/d"
                        }
                    },
                    "aggs": {
                        "testsuite": {
                            "terms": {
                                "field": "testsuite",
                                "size": 100
                            },
                            "aggs": {
                                "build_number": {
                                    "terms": {
                                        "field": "build_number",
                                        "size": 1,
                                        "order": {
                                            "_term": "desc"
                                        }
                                    },
                                    "aggs": {
                                        "time_2": {
                                            "terms": {
                                                "field": "time_ran_at",
                                                "size":1,
                                                "order":{
                                                    "_term":"desc"
                                                }
                                            },
                                            "aggs": {
                                                "result": {
                                                    "terms": {
                                                        "field": "result"
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}