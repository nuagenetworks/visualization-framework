{
  "id": "inf-testbed-failure-express",
  "title": "",
  "service": "elasticsearch",
  "tabify":"infraStackedBar",
  "query": {
    "index": "nuage_regress",
    "type": "nuage_doc_type",
    "body": {
      "size": 0,
      "query": {
        "bool": {
          "must": [
            {
              "range": {
                "time_regression_started": {
                  "gte": "{{startTime:now-7d}}",
                  "lte": "{{endTime:now}}",
                  "format": "epoch_millis",
									"time_zone":"America/Los_Angeles"
                }
              }
            },
            {
              "term": {
                "testcase": ""
              }
            },
            {
              "regexp": {
                "testbed": "(wfdcvtb01|wfdcdev02|wfdcdev03)"
              }
            },
            {
              "terms": {
                "testsuite": [
                  "initial",
                  "sanity",
                  "Sanity"
                ]
              }
            },
            {
              "wildcard":{
                "testbed":"{{site}}"
              }
            }
          ]
        }
      },
      "aggs": {
        "testbed": {
          "terms": {
            "field": "testbed",
            "size": 2000
          },
           "aggs": {
            "failed_jobs": {
              "cardinality": {
                "script": {
                  "inline": "doc['result'].value !=2 ? doc['args'].value.contains('-customInfra') ? null: doc['job_id'].value : null"
                }
              }
            },
            "total_jobs": {
              "cardinality": {
                "field": "job_id"
              }
            },
            "runs_count": {
              "bucket_script": {
                "buckets_path": {
                  "failed_jobs": "failed_jobs",
                  "total_jobs": "total_jobs"
                },
                "script": "params.total_jobs - params.failed_jobs"
              }
            }
          }
        }
      }
    }
  }
}